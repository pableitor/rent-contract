<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrato Airbnb</title>
</head>
<body>
  <div style="text-align:center; margin: 20px;">
    <label for="reservaId"><strong>Num. Reserva Airbnb:</strong></label>
    <input type="text" id="reservaId" style="margin-left:10px; padding:6px; width:250px;">
    <button onclick="abrirReserva()" style="margin-left:10px; padding:6px 12px;">üîç Abrir</button>
    <button onclick="importarDatosDesdeExtension()" style="margin-left:10px; padding:6px 12px;">üì• Importar datos</button>
  </div>

  <div id="contrato">
    <p>Nombre del hu√©sped: <input type="text" id="guestname" class="placeholder"></p>
    <p>Direcci√≥n del alojamiento: <input type="text" class="placeholder full-width-input"></p>
    <p>Desde: <input type="date" id="fechaInicio" class="placeholder"> Hasta: <input type="date" id="fechaFin" class="placeholder"></p>
  </div>

  <button onclick="subirPDFaS3()">üì§ Subir PDF a S3</button>

  <div id="resultado" style="display:none; text-align:center; margin-top:20px;">
    <input id="urlPdf" type="text" readonly style="width:80%; padding:8px;">
    <button onclick="copiarLink()">üìã Copiar</button>
    <button onclick="compartirWhatsApp()">üì≤ WhatsApp</button>
  </div>

<script>
  function abrirReserva() {
    const reserva = document.getElementById('reservaId').value.trim();
    if (!reserva) {
      alert("Introduce un n√∫mero de reserva v√°lido.");
      return;
    }
    const url = `https://www.airbnb.es/hosting/stay/${reserva}`;
    window.open(url, '_blank');
  }

  function importarDatosDesdeExtension() {
    if (typeof chrome === 'undefined' || !chrome.storage) {
      alert('‚ùó Este bot√≥n solo funciona desde una extensi√≥n o entorno con permisos de Chrome.');
      return;
    }

    chrome.storage.local.get(["nombre", "alojamiento", "fechas"], function (result) {
      const { nombre, alojamiento, fechas } = result;
      if (!nombre || !alojamiento || !fechas) {
        alert("‚ö†Ô∏è No hay datos disponibles. Aseg√∫rate de haber usado la extensi√≥n primero.");
        return;
      }

      document.getElementById("guestname").value = nombre;
      const alojamientoField = document.querySelectorAll("input.placeholder.full-width-input")[0];
      if (alojamientoField) alojamientoField.value = alojamiento;

      const fechasRegex = /(\d{1,2})\s(\w+)\s[\u2013\-]\s(\d{1,2})\s(\w+)/;
      const match = fechas.match(fechasRegex);
      if (match) {
        const diaInicio = match[1];
        const mesInicio = match[2];
        const diaFin = match[3];
        const mesFin = match[4];

        const meses = {
          "ene": "01", "feb": "02", "mar": "03", "abr": "04",
          "may": "05", "jun": "06", "jul": "07", "ago": "08",
          "sept": "09", "oct": "10", "nov": "11", "dic": "12"
        };

        const a√±oActual = new Date().getFullYear();
        const fechaInicio = `${a√±oActual}-${meses[mesInicio.toLowerCase().slice(0, 3)]}-${diaInicio.padStart(2, '0')}`;
        const fechaFin = `${a√±oActual}-${meses[mesFin.toLowerCase().slice(0, 3)]}-${diaFin.padStart(2, '0')}`;

        document.getElementById("fechaInicio").value = fechaInicio;
        document.getElementById("fechaFin").value = fechaFin;
      }

      alert("‚úÖ Datos importados desde la extensi√≥n");
    });
  }

  function subirPDFaS3() {
    const element = document.getElementById('contrato');
    const guest = document.getElementById('guestname').value.trim().replace(/ /g, "_");
    const fileName = 'contrato-' + guest + Date.now() + '.pdf';
    alert("(Simulaci√≥n) Se subir√≠a el PDF con nombre: " + fileName);
    document.getElementById("urlPdf").value = `https://bucket.s3.amazonaws.com/${fileName}`;
    document.getElementById("resultado").style.display = 'block';
  }

  function copiarLink() {
    const urlInput = document.getElementById('urlPdf');
    urlInput.select();
    document.execCommand('copy');
    alert('üìã Enlace copiado al portapapeles');
  }

  function compartirWhatsApp() {
    const url = document.getElementById('urlPdf').value;
    const mensaje = encodeURIComponent("üìÑ Aqu√≠ tienes el contrato:\n" + url);
    const enlace = `https://wa.me/?text=${mensaje}`;
    window.open(enlace, '_blank');
  }
</script>
</body>
</html>
