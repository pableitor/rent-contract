<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contrato de Alquiler con Firma</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #contrato { border: 1px solid #ccc; padding: 20px; }
    canvas { border: 1px solid #000; width: 100%; height: 150px; }
    .firma-container { margin-top: 20px; }
    label { font-weight: bold; }
  </style>
</head>
<body>

<h2>Contrato de Alquiler - Firma Digital</h2>
<form id="formulario">
  <div id="contrato">
    <p>Entre <strong><input type="text" name="propietario" value="Juan Pérez"/></strong> (propietario) y <strong><input type="text" name="inquilino" value="María García"/></strong> (inquilino), se acuerda el alquiler de la habitación ubicada en <strong><input type="text" name="direccion" value="Calle Falsa 123, Madrid"/></strong> desde el día <strong><input type="date" name="fecha_inicio"/></strong> hasta el día <strong><input type="date" name="fecha_fin"/></strong>.</p>

    <p>Ambas partes aceptan las condiciones expresadas en este contrato.</p>

    <div class="firma-container">
      <label>Firma del propietario:</label>
      <canvas id="firmaPropietario"></canvas>
      <button type="button" onclick="borrarFirma('propietario')">Borrar Firma</button>
    </div>

    <div class="firma-container">
      <label>Firma del inquilino:</label>
      <canvas id="firmaInquilino"></canvas>
      <button type="button" onclick="borrarFirma('inquilino')">Borrar Firma</button>
    </div>
  </div>

  <br>
  <label>Email del propietario:</label>
  <input type="email" id="emailPropietario" required />
  <br><br>
  <button type="button" onclick="enviarContrato()">Firmar y Enviar</button>
</form>

<script>
  const canvasProp = document.getElementById("firmaPropietario");
  const canvasInq = document.getElementById("firmaInquilino");
  const padProp = new SignaturePad(canvasProp);
  const padInq = new SignaturePad(canvasInq);

  function borrarFirma(tipo) {
    if (tipo === 'propietario') padProp.clear();
    else padInq.clear();
  }

  emailjs.init("F3TxaJUcv0LRZLFu3"); // reemplaza con tu User ID de EmailJS

  function enviarContrato() {
    if (padProp.isEmpty() || padInq.isEmpty()) {
      alert("Por favor, firma ambos campos.");
      return;
    }

    const email = document.getElementById("emailPropietario").value;
    const contrato = document.getElementById("contrato");

    html2pdf().set({
      margin: 1,
      filename: 'contrato_firmado.pdf',
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    }).from(contrato).outputPdf('datauristring').then(function (pdfBase64) {
      const downloadLink = document.createElement('a');
      downloadLink.href = pdfBase64;
      downloadLink.download = "contrato_firmado.pdf";
      downloadLink.click();

      // Enlace de descarga incluido en el email
      emailjs.send("service_kdvoczb", "template_x9pv9ur", {
        to_email: email,
        message: "Puedes descargar el contrato firmado desde el siguiente enlace:\n" + pdfBase64
      }, "F3TxaJUcv0LRZLFu3")
      .then(() => alert("✅ Contrato enviado con enlace de descarga"))
      .catch((e) => {
        console.error("EmailJS Error:", e);
        alert("❌ Error al enviar: " + JSON.stringify(e));
      });
    });
  }
</script>
</body>
</html>
